# 🗑️ 麦麦上下文清理插件

清除麦麦的聊天记录，让她"忘记"之前的对话。

---

## 📝 功能简介

这个插件让你能够：
- 🧹 清除所有聊天上下文
- 📊 清除最近N条消息
- ⏰ 清除指定时间之前的消息
- 🔐 基于权限控制，只有授权用户可使用

---

## ✨ 核心特性

### 1. **多种清除模式**
- **全部清除** - 删除所有聊天记录
- **最近N条** - 只删除最近的N条消息
- **时间范围** - 删除N小时之前的消息

### 2. **权限控制**
- 基于用户ID的白名单机制
- 只有配置文件中的用户才能使用
- 防止误操作和滥用

### 3. **即时生效**
- 命令执行后立即清除数据库记录
- 麦麦会"忘记"已清除的对话内容

---

## 🚀 快速开始

### 第一次使用

**1. 配置权限**

编辑配置文件 `config.toml`：

```toml
[plugin]
enabled = true
permission = ["1334431750", "123456789"]  # 添加你的QQ号
```

**重要**：
- QQ号必须用引号包裹（字符串格式）
- 多个用户用逗号分隔
- 修改后需重启麦麦

**2. 获取你的QQ号**

如果不知道自己的QQ号格式，可以查看：
- QQ个人资料
- 或询问麦麦："我的用户ID是多少"

**3. 使用命令**

```
/clear help
```

---

## 🎮 命令使用

| 命令 | 说明 | 示例 |
|------|------|------|
| `/clear help` | 查看帮助信息 | `/clear help` |
| `/clear all` | 清除所有上下文 | `/clear all` |
| `/clear recent <N>` | 清除最近N条消息 | `/clear recent 20` |
| `/clear before <N>` | 清除N小时前的消息 | `/clear before 48` |

**命令别名：**
- `/clear` = `/清除上下文` = `/清空上下文`

### 使用示例

**清除所有记录：**
```
用户：/clear all
麦麦：✅ 已清除所有上下文
     删除了 150 条消息记录
```

**清除最近50条：**
```
用户：/clear recent 50
麦麦：✅ 已清除最近 50 条消息
     实际删除了 50 条记录
```

**清除3天前的消息：**
```
用户：/clear before 72
麦麦：✅ 已清除 72 小时前的消息
     删除了 80 条记录
```

**无权限时：**
```
用户：/clear all
麦麦：❌ 你没有权限使用清除上下文命令
```

---

## ⚙️ 配置说明

配置文件：`config.toml`

### 基础配置

```toml
[plugin]
enabled = true              # 是否启用插件
config_version = "1.0.0"   # 配置版本
permission = ["1334431750"] # 有权限的用户ID列表
```

### 权限配置示例

**单个管理员：**
```toml
permission = ["1334431750"]
```

**多个管理员：**
```toml
permission = ["1334431750", "123456789", "987654321"]
```

**禁用所有人：**
```toml
permission = []  # 空列表，没有人可以使用
```

---

## ⚠️ 安全提示

### 重要警告

- **清除后无法恢复！** 数据库记录会被永久删除
- 建议只授予**可信用户**权限
- 清除前请**确认操作**
- 不要随意清除**重要对话**

### 最佳实践

1. **定期清理** - 定期清除旧消息，避免数据库膨胀
2. **权限最小化** - 只给必要的用户添加权限
3. **备份数据** - 清除重要对话前先备份数据库

---

## ❓ 常见问题

### Q: 为什么命令没有响应？
A: 检查以下几点：
1. 插件是否启用（`config.toml` 中 `enabled = true`）
2. 命令格式是否正确
3. 查看日志中是否有错误信息

### Q: 为什么提示我没有权限？
A: 确保：
1. 你的QQ号在 `permission` 列表中
2. QQ号使用字符串格式（有引号）
3. 修改配置后已重启麦麦

### Q: 清除后麦麦还记得之前的对话？
A: 检查：
1. 是否真的删除成功（看返回的删除数量）
2. 可能是麦麦使用了其他记忆机制（如情绪模块）

### Q: 如何查看当前有多少条消息？
A: 暂不支持查询功能，建议清除前估算：
- `recent` 模式会显示实际删除数量
- `before` 模式会显示符合条件的消息数

### Q: 清除会影响其他功能吗？
A: 会影响依赖聊天历史的功能：
- 上下文理解（麦麦会"忘记"之前说的话）
- 情绪记忆（部分插件可能使用消息历史）
- 建议谨慎使用 `clear all`

---

## 🔧 技术细节

### 插件信息
- **插件名称**: `context_clear_plugin`
- **版本**: `1.0.0`
- **数据库**: 直接操作 Messages 表（Peewee ORM）

### 命令模式
```python
# 命令正则
r"^/(clear|清除上下文|清空上下文)\s*(.*?)$"

# 子命令
- help    # 帮助
- all     # 全部清除
- recent <N>  # 最近N条
- before <N>  # N小时前
```

### 清除逻辑
```python
# all 模式
Messages.delete().where(Messages.stream_id == chat_id)

# recent 模式
最近的N条消息 → 按时间倒序取N条 → 批量删除

# before 模式
Messages.delete().where(
    (Messages.stream_id == chat_id) &
    (Messages.timestamp < (now - timedelta(hours=N)))
)
```

---

## 📂 文件结构

```
context_clear_plugin/
├── README.md       # 本文档
├── config.toml     # 配置文件
├── plugin.py       # 插件主文件
├── __init__.py     # Python包文件
└── _manifest.json  # 插件元数据
```

---

## 🔄 版本信息

**当前版本**: 1.0.0

**主要特性**:
- ✅ 三种清除模式
- ✅ 权限控制
- ✅ 即时生效
- ✅ 友好的提示信息

---

## 📞 支持

遇到问题？
1. 检查配置文件格式是否正确
2. 查看日志：`/home/ubuntu/maimai/MaiBot/logs/`
3. 使用 `/clear help` 查看命令帮助

---

**谨慎使用，清除后无法恢复！** 🚨
